#!/usr/bin/env node
import{EventEmitter as t}from"events";import n from"fs";import e from"prompts";function s(t){return null==t?[]:Array.isArray(t)?t:[t]}function o(t,n,e,s){var o,i=t[n],a=~s.string.indexOf(n)?null==e||!0===e?"":String(e):"boolean"==typeof e?e:~s.boolean.indexOf(n)?"false"!==e&&("true"===e||(t._.push(0*(o=+e)==0?o:e),!!e)):0*(o=+e)==0?o:e;t[n]=null==i?a:Array.isArray(i)?i.concat(a):[i,a]}const i=t=>t.replace(/[<[].+/,"").trim(),a=t=>t.sort((t,n)=>t.length>n.length?-1:1)[0],r=(t,n)=>t.length>=n?t:`${t}${" ".repeat(n-t.length)}`,l=(t,n,e)=>{let s,o=0,i=n.length,a=t;for(;o<i;++o)s=a[n[o]],a=a[n[o]]=o===i-1?e:null!=s?s:!~n[o+1].indexOf(".")&&+n[o+1]>-1?[]:{}},c=(t,n)=>{for(const e of Object.keys(n)){const s=n[e];s.shouldTransform&&(t[e]=Array.prototype.concat.call([],t[e]),"function"==typeof s.transformFunction&&(t[e]=t[e].map(s.transformFunction)))}},m=t=>t.split(".").map((t,n)=>0===n?t.replace(/([a-z])-([a-z])/g,(t,n,e)=>n+e.toUpperCase()):t).join(".");class h extends Error{constructor(t){super(t),this.name=this.constructor.name,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error(t).stack}}class u{constructor(t,n,e){this.rawName=t,this.description=n,this.config=Object.assign({},e),t=t.replace(/\.\*/g,""),this.negated=!1,this.names=i(t).split(",").map(t=>{let n=t.trim().replace(/^-{1,2}/,"");return n.startsWith("no-")&&(this.negated=!0,n=n.replace(/^no-/,"")),m(n)}).sort((t,n)=>t.length>n.length?1:-1),this.name=this.names[this.names.length-1],this.negated&&null==this.config.default&&(this.config.default=!0),t.includes("<")?this.required=!0:t.includes("[")?this.required=!1:this.isBoolean=!0}}const p=process.argv,d=`${process.platform}-${process.arch} node-${process.version}`;class f{constructor(t,n,e={},s){this.rawName=t,this.description=n,this.config=e,this.cli=s,this.options=[],this.aliasNames=[],this.name=i(t),this.args=(t=>{const n=/<([^>]+)>/g,e=/\[([^\]]+)\]/g,s=[],o=t=>{let n=!1,e=t[1];return e.startsWith("...")&&(e=e.slice(3),n=!0),{required:t[0].startsWith("<"),value:e,variadic:n}};let i,a;for(;i=n.exec(t);)s.push(o(i));for(;a=e.exec(t);)s.push(o(a));return s})(t),this.examples=[]}usage(t){return this.usageText=t,this}allowUnknownOptions(){return this.config.allowUnknownOptions=!0,this}ignoreOptionDefaultValue(){return this.config.ignoreOptionDefaultValue=!0,this}version(t,n="-v, --version"){return this.versionNumber=t,this.option(n,"Display version number"),this}example(t){return this.examples.push(t),this}option(t,n,e){const s=new u(t,n,e);return this.options.push(s),this}alias(t){return this.aliasNames.push(t),this}action(t){return this.commandAction=t,this}isMatched(t){return this.name===t||this.aliasNames.includes(t)}get isDefaultCommand(){return""===this.name||this.aliasNames.includes("!")}get isGlobalCommand(){return this instanceof g}hasOption(t){return t=t.split(".")[0],this.options.find(n=>n.names.includes(t))}outputHelp(){const{name:t,commands:n}=this.cli,{versionNumber:e,options:s,helpCallback:o}=this.cli.globalCommand;let i=[{body:`${t}${e?`/${e}`:""}`}];i.push({title:"Usage",body:`  $ ${t} ${this.usageText||this.rawName}`});if((this.isGlobalCommand||this.isDefaultCommand)&&n.length>0){const e=a(n.map(t=>t.rawName));i.push({title:"Commands",body:n.map(t=>`  ${r(t.rawName,e.length)}  ${t.description}`).join("\n")}),i.push({title:"For more info, run any command with the `--help` flag",body:n.map(n=>`  $ ${t}${""===n.name?"":` ${n.name}`} --help`).join("\n")})}let l=this.isGlobalCommand?s:[...this.options,...s||[]];if(this.isGlobalCommand||this.isDefaultCommand||(l=l.filter(t=>"version"!==t.name)),l.length>0){const t=a(l.map(t=>t.rawName));i.push({title:"Options",body:l.map(n=>`  ${r(n.rawName,t.length)}  ${n.description} ${void 0===n.config.default?"":`(default: ${n.config.default})`}`).join("\n")})}this.examples.length>0&&i.push({title:"Examples",body:this.examples.map(n=>"function"==typeof n?n(t):n).join("\n")}),o&&(i=o(i)||i),console.log(i.map(t=>t.title?`${t.title}:\n${t.body}`:t.body).join("\n\n"))}outputVersion(){const{name:t}=this.cli,{versionNumber:n}=this.cli.globalCommand;n&&console.log(`${t}/${n} ${d}`)}checkRequiredArgs(){const t=this.args.filter(t=>t.required).length;if(this.cli.args.length<t)throw new h(`missing required args for command \`${this.rawName}\``)}checkUnknownOptions(){const{options:t,globalCommand:n}=this.cli;if(!this.config.allowUnknownOptions)for(const e of Object.keys(t))if("--"!==e&&!this.hasOption(e)&&!n.hasOption(e))throw new h(`Unknown option \`${e.length>1?`--${e}`:`-${e}`}\``)}checkOptionValue(){const{options:t,globalCommand:n}=this.cli,e=[...n.options,...this.options];for(const n of e){const s=t[n.name.split(".")[0]];if(n.required){const t=e.some(t=>t.negated&&t.names.includes(n.name));if(!0===s||!1===s&&!t)throw new h(`option \`${n.rawName}\` value is missing`)}}}}class g extends f{constructor(t){super("@@global@@","",{},t)}}var b=Object.assign;class y extends t{constructor(t=""){super(),this.name=t,this.commands=[],this.rawArgs=[],this.args=[],this.options={},this.globalCommand=new g(this),this.globalCommand.usage("<command> [options]")}usage(t){return this.globalCommand.usage(t),this}command(t,n,e){const s=new f(t,n||"",e,this);return s.globalCommand=this.globalCommand,this.commands.push(s),s}option(t,n,e){return this.globalCommand.option(t,n,e),this}help(t){return this.globalCommand.option("-h, --help","Display this message"),this.globalCommand.helpCallback=t,this.showHelpOnExit=!0,this}version(t,n="-v, --version"){return this.globalCommand.version(t,n),this.showVersionOnExit=!0,this}example(t){return this.globalCommand.example(t),this}outputHelp(){this.matchedCommand?this.matchedCommand.outputHelp():this.globalCommand.outputHelp()}outputVersion(){this.globalCommand.outputVersion()}setParsedInfo({args:t,options:n},e,s){return this.args=t,this.options=n,e&&(this.matchedCommand=e),s&&(this.matchedCommandName=s),this}unsetMatchedCommand(){this.matchedCommand=void 0,this.matchedCommandName=void 0}parse(t=p,{run:n=!0}={}){this.rawArgs=t,this.name||(this.name=t[1]?(t=>{const n=/([^\\\/]+)$/.exec(t);return n?n[1]:""})(t[1]):"cli");let e=!0;for(const n of this.commands){const s=this.mri(t.slice(2),n),o=s.args[0];if(n.isMatched(o)){e=!1;const t=b(b({},s),{args:s.args.slice(1)});this.setParsedInfo(t,n,o),this.emit(`command:${o}`,n)}}if(e)for(const n of this.commands)if(""===n.name){e=!1;const s=this.mri(t.slice(2),n);this.setParsedInfo(s,n),this.emit("command:!",n)}if(e){const n=this.mri(t.slice(2));this.setParsedInfo(n)}this.options.help&&this.showHelpOnExit&&(this.outputHelp(),n=!1,this.unsetMatchedCommand()),this.options.version&&this.showVersionOnExit&&null==this.matchedCommandName&&(this.outputVersion(),n=!1,this.unsetMatchedCommand());const s={args:this.args,options:this.options};return n&&this.runMatchedCommand(),!this.matchedCommand&&this.args[0]&&this.emit("command:*"),s}mri(t,n){const e=[...this.globalCommand.options,...n?n.options:[]],i=(t=>{const n={alias:{},boolean:[]};for(const[e,s]of t.entries())s.names.length>1&&(n.alias[s.names[0]]=s.names.slice(1)),s.isBoolean&&(s.negated&&t.some((t,n)=>n!==e&&t.names.some(t=>s.names.includes(t))&&"boolean"==typeof t.required)||n.boolean.push(s.names[0]));return n})(e);let a=[];const r=t.indexOf("--");r>-1&&(a=t.slice(r+1),t=t.slice(0,r));let h=function(t,n){n=n||{};var e,i,a,r,l,c={_:[]},m=0,h=0,u=0,p=(t=t||[]).length;const d=void 0!==n.alias,f=void 0!==n.unknown,g=void 0!==n.default;if(n.alias=n.alias||{},n.string=s(n.string),n.boolean=s(n.boolean),d)for(e in n.alias)for(i=n.alias[e]=s(n.alias[e]),m=0;m<i.length;m++)(n.alias[i[m]]=i.concat(e)).splice(m,1);for(m=n.boolean.length;m-- >0;)for(h=(i=n.alias[n.boolean[m]]||[]).length;h-- >0;)n.boolean.push(i[h]);for(m=n.string.length;m-- >0;)for(h=(i=n.alias[n.string[m]]||[]).length;h-- >0;)n.string.push(i[h]);if(g)for(e in n.default)if(r=typeof n.default[e],i=n.alias[e]=n.alias[e]||[],void 0!==n[r])for(n[r].push(e),m=0;m<i.length;m++)n[r].push(i[m]);const b=f?Object.keys(n.alias):[];for(m=0;m<p;m++){if("--"===(a=t[m])){c._=c._.concat(t.slice(++m));break}for(h=0;h<a.length&&45===a.charCodeAt(h);h++);if(0===h)c._.push(a);else if("no-"===a.substring(h,h+3)){if(r=a.substring(h+3),f&&!~b.indexOf(r))return n.unknown(a);c[r]=!1}else{for(u=h+1;u<a.length&&61!==a.charCodeAt(u);u++);for(r=a.substring(h,u),l=a.substring(++u)||m+1===p||45===(""+t[m+1]).charCodeAt(0)||t[++m],i=2===h?[r]:r,u=0;u<i.length;u++){if(r=i[u],f&&!~b.indexOf(r))return n.unknown("-".repeat(h)+r);o(c,r,u+1<i.length||l,n)}}}if(g)for(e in n.default)void 0===c[e]&&(c[e]=n.default[e]);if(d)for(e in c)for(i=n.alias[e]||[];i.length>0;)c[i.shift()]=c[e];return c}(t,i);h=Object.keys(h).reduce((t,n)=>b(b({},t),{[m(n)]:h[n]}),{_:[]});const u=h._,p={"--":a},d=n&&n.config.ignoreOptionDefaultValue?n.config.ignoreOptionDefaultValue:this.globalCommand.config.ignoreOptionDefaultValue;let f=Object.create(null);for(const t of e){if(!d&&void 0!==t.config.default)for(const n of t.names)p[n]=t.config.default;Array.isArray(t.config.type)&&void 0===f[t.name]&&(f[t.name]=Object.create(null),f[t.name].shouldTransform=!0,f[t.name].transformFunction=t.config.type[0])}for(const t of Object.keys(h))if("_"!==t){const n=t.split(".");l(p,n,h[t]),c(p,f)}return{args:u,options:p}}runMatchedCommand(){const{args:t,options:n,matchedCommand:e}=this;if(!e||!e.commandAction)return;e.checkUnknownOptions(),e.checkOptionValue(),e.checkRequiredArgs();const s=[];return e.args.forEach((n,e)=>{n.variadic?s.push(t.slice(e)):s.push(t[e])}),s.push(n),e.commandAction.apply(this,s)}}const w=((t="")=>new y(t))("rawfox");const x=[{type:"toggle",name:"declaration",message:"是否生成类型声明文件？",initial:!1}],C='export default {\n    input: "./src/",\n    output: "./dist/",\n    outputOptions: {\n        declarationFile: __declaration__,\n    }\n}',v={declaration:!1};!function(t){const n=w.command(`${t.name} [${t.valueName}]`,t.description);if(t.options)for(const e of t.options)n.option(`${e.name?"-"+e.name+", ":""}--${e.otherName} ${"valued"===e.type?"<"+e.valueName+">":""}`,e.description??"");n.action(async(n,e)=>{await t.action(n,e)})}({name:"init",valueName:"value",description:"初始化一个rawfox项目",options:[{name:"y",otherName:"default",type:"boolean"},{name:"t",otherName:"template",type:"boolean"}],async action(t,s){try{n.accessSync("rawfox.config.js"),console.log("rawfox.config.js文件已存在。")}catch{let t;if(t=s.default?v:await e(x),n.writeFileSync("rawfox.config.js",function(t){let n=C;for(const e of Object.keys(t))n=C.replaceAll(`__${e}__`,t[e]??"");return n}(t)),s.template){const t=await e({type:"text",name:"projectName",initial:"my-components-library",message:"项目名称"});n.mkdirSync("src"),n.writeFileSync("package.json",JSON.stringify({name:t.projectName,version:"1.0.0",description:"",main:"index.js",scripts:{test:'echo "Error: no test specified" && exit 1'},keywords:[],author:"",license:"ISC",type:"commonjs"})),n.opendirSync("src"),n.writeFileSync("src/my-component.rawfox",'<script lang="js">\n                    //This is the Configuration Object.\n                    export default {\n                        name: "my-component", // The component name must be xxx-xxx.\n                        syncData: { //Sync data, when the data update, the template will also update.\n                            count: 1\n                        },\n                        mounted() { // When the component is mounted into the document, this function will be executed.\n                            const base = useTemplate("baseElement")\n                            base.onclick = () => this.syncData.count++\n                        }\n                    }\n                <\/script>\n                <template>\n                    \x3c!--Build your fist Web Component.--\x3e\n                    <div rawfox-use="baseElement">{{ $syncData.count }}</div>\n                </template>\n                <style>\n                    /*You can use <style> to construct styles for components.*/\n                    div {\n                        background-color: white;\n                        color: black;\n                        padding: 5px 8px;\n                        border-radius: 10px;\n                        cursor: pointer;\n                    }\n                    &:hover {\n                        background-color: rgb(230, 230, 230);\n                    }\n                </style>')}console.log("项目初始化完成")}}}),w.help(),w.parse();
